---
- scm:
    name: env-sync-and-backup_Copy_Data_to_Staging
    scm:
        - git:
            url: git@github.gds:gds/env-sync-and-backup.git
            branches:
              - master

- job:
    name: Copy_Data_to_Staging
    display-name: Copy_Data_to_Staging
    project-type: freestyle
    description: "This job currently copies all MongoDB databases from Backend. For MySQL, only whitelisted apps have
      their databases copied because several have sensitive data."
    properties:
        - github:
            url: https://github.gds/gds/env-sync-and-backup/
    scm:
      - env-sync-and-backup_Copy_Data_to_Staging
    logrotate:
        artifactNumToKeep: 10
    triggers:
        - timed: 'H 1 * * *'
    builders:
        - shell: |
            set +x
            cd "${WORKSPACE}"

            set +e

            echo "Disabling Gor traffic replay"
            for box in $(govuk_node_list -C 'govuk::gor'); do
              ssh deploy@${box} 'echo "true" > /etc/govuk/env.d/FACTER_data_sync_in_progress; sudo initctl stop gor';
            done

            echo "Running Data Sync"
            export MYSQL_SRC_ROOT_PW='<%= @mysql_src_root_pw %>' \
            export MYSQL_DST_ROOT_PW='<%= @mysql_dst_root_pw %>' \
            export PG_SRC_ENV_SYNC_PW='<%= @pg_src_env_sync_pw %>' \
            export PG_DST_ENV_SYNC_PW='<%= @pg_dst_env_sync_pw %>' \
            bash sync production staging
            EXITCODE=$?

            echo "Re-enabling Gor traffic replay"
            for box in $(govuk_node_list -C 'govuk::gor'); do
              ssh deploy@${box} 'echo "" > /etc/govuk/env.d/FACTER_data_sync_in_progress; sudo initctl start gor';
            done

            exit $EXITCODE
        - shell: |
            echo "Triggering post-sync job on deploy.staging.publishing.service.gov.uk"
            curl -f -XPOST https://ci_alphagov:<%= @ci_alphagov_api_key %>@deploy.staging.publishing.service.gov.uk/job/Data_Sync_Complete/build -d token=<%= @ci_alphagov_api_token %> --data-urlencode json="{}"
    wrappers:
        - ansicolor:
            colormap: xterm
        - inject:
            script-content: PARALLEL_JOBS=2
    parameters:
        - choice:
            name: JOBLIST
            description: 'Choose the thing to sync. All is the default, but some jobs may run but not do anything due to your config for the destination environment.'
            choices:
                - all
                - assets
                - elasticsearch-api
                - elasticsearch-backend
                - mysql-efg
                - mysql-normal
                - mysql-whitehall
                - mongo-exceptions
                - mongo-licensify
                - mongo-normal
                - mongo-router
                - postgresql-backend
